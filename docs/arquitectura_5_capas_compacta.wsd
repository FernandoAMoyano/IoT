@startuml Arquitectura IoT - Vista Compacta

!theme plain
skinparam backgroundColor #FFFFFF
skinparam packageStyle rectangle

title <size:20><b>Arquitectura de 5 Capas IoT</b></size>\nSistema de Control de IluminaciÃ³n AutomÃ¡tica

' ========== CAPA 5 ==========
rectangle "<size:16><b>CAPA 5: APLICACIÃ“N</b></size>\n<color:#4CAF50><b>LÃ³gica de Negocio</b></color>" as layer5 #E3F2FD {
    
    rectangle "<b>Grafana</b>\nDashboard Web\nâ”â”â”â”â”â”â”â”â”â”â”\n6 Paneles:\nâ€¢ Serie temporal\nâ€¢ Estado LED\nâ€¢ GrÃ¡fico torta\nâ€¢ Tabla datos\nâ€¢ EstadÃ­sticas\nâ€¢ Contador" as grafana #4CAF50
    
    database "<b>MySQL</b>\nBase de Datos\nâ”â”â”â”â”â”â”â”â”â”â”\nTabla: datos_luminosidad\nâ€¢ id, nivel_luz\nâ€¢ estado_led\nâ€¢ clasificacion\nâ€¢ timestamp" as mysql #FF9800
    
    rectangle "<b>Servidor Python</b>\nLÃ³gica Central\nâ”â”â”â”â”â”â”â”â”â”â”\nâ€¢ Cliente MQTT\nâ€¢ ClasificaciÃ³n datos\nâ€¢ Almacenamiento BD\nâ”â”â”â”â”â”â”â”â”â”â”\nUmbral: â‰¤750=BAJA\n>750=ALTA" as python #2196F3
}

' ========== CAPA 4 ==========
rectangle "<size:16><b>CAPA 4: TRANSPORTE</b></size>\n<color:#9C27B0><b>Protocolo MQTT</b></color>" as layer4 #F3E5F5 {
    
    cloud "<b>Broker MQTT</b>\nHiveMQ PÃºblico\nâ”â”â”â”â”â”â”â”â”â”â”\nPuerto: 1883\nModelo: Pub/Sub\nQoS: 0" as broker #9C27B0 {
        queue "iot/luminosidad" as topic1 #CE93D8
        queue "iot/led/estado" as topic2 #CE93D8
    }
}

' ========== CAPA 3 ==========
rectangle "<size:16><b>CAPA 3: RED</b></size>\n<color:#1565C0><b>Protocolos TCP/IP</b></color>" as layer3 #E1F5FE {
    
    cloud "<b>Internet</b>\nâ”â”â”â”â”â”â”â”â”â”â”\nâ€¢ Enrutamiento IP\nâ€¢ DNS\nâ€¢ Gateway" as internet #1565C0
}

' ========== CAPA 2 ==========
rectangle "<size:16><b>CAPA 2: CONECTIVIDAD</b></size>\n<color:#FF6F00><b>WiFi 2.4 GHz</b></color>" as layer2 #FFF3E0 {
    
    node "<b>WiFi 802.11</b>\nâ”â”â”â”â”â”â”â”â”â”â”\nâ€¢ SSID: Red Local\nâ€¢ WPA2\nâ€¢ DHCP" as wifi #FF9800
}

' ========== CAPA 1 ==========
rectangle "<size:16><b>CAPA 1: FÃSICA</b></size>\n<color:#2E7D32><b>Hardware</b></color>" as layer1 #E8F5E9 {
    
    rectangle "<b>ESP32 DevKit</b>\nâ”â”â”â”â”â”â”â”â”â”â”\nCPU: 32-bit Xtensa\nWiFi integrado\nADC: 12-bit\nFirmware: MicroPython\nâ”â”â”â”â”â”â”â”â”â”â”\nCiclo: cada 2 seg" as esp32 #4CAF50
    
    component "<b>Sensor LDR</b>\nâ”â”â”â”â”â”â”â”â”â”â”\nPin: GPIO 36\nRango: 0-1023\nUmbral: 750" as ldr #2196F3
    
    component "<b>LED</b>\nâ”â”â”â”â”â”â”â”â”â”â”\nPin: GPIO 18\nON = Poca luz\nOFF = Luz suficiente" as led #F44336
}

' ========== CONEXIONES PRINCIPALES ==========

ldr -[#2196F3]-> esp32 : <color:#2196F3>SeÃ±al\nanalÃ³gica
esp32 -[#F44336]-> led : <color:#F44336>Control\ndigital

esp32 -[#FF9800]-> wifi : <color:#FF9800>ConexiÃ³n\nWiFi
wifi -[#1565C0]-> internet : <color:#1565C0>Paquetes\nIP
internet -[#9C27B0]-> broker : <color:#9C27B0>TCP\n:1883

esp32 .[#9C27B0].> topic1 : <color:#9C27B0>PUBLISH
esp32 .[#9C27B0].> topic2 : <color:#9C27B0>PUBLISH

topic1 .[#9C27B0].> python : <color:#9C27B0>SUBSCRIBE
topic2 .[#9C27B0].> python : <color:#9C27B0>SUBSCRIBE

python -[#FF9800]-> mysql : <color:#FF9800>INSERT\nDatos
mysql -[#4CAF50]-> grafana : <color:#4CAF50>SELECT\ncada 5s

' ========== ANOTACIONES ==========

note right of esp32
    <b><color:#4CAF50>CICLO PRINCIPAL</color></b>
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    <b>1.</b> Leer sensor LDR
    <b>2.</b> Convertir ADC (0-1023)
    <b>3.</b> Evaluar umbral â‰¤750?
    <b>4.</b> Controlar LED (ON/OFF)
    <b>5.</b> Publicar MQTT:
       â€¢ luminosidad
       â€¢ estado_led
    <b>6.</b> Esperar 2 segundos
    <b>7.</b> Repetir infinitamente
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    <color:#F44336>Manejo de errores:</color>
    â€¢ ReconexiÃ³n WiFi auto
    â€¢ Reintentos MQTT
    â€¢ Funcionamiento local
end note

note left of grafana
    <b><color:#2196F3>VISUALIZACIÃ“N</color></b>
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    <b>ActualizaciÃ³n: cada 5s</b>
    
    <b>Consultas SQL en tiempo real:</b>
    â€¢ SELECT nivel_luz, timestamp
    â€¢ WHERE timestamp >= NOW() - 15m
    â€¢ GROUP BY clasificacion
    â€¢ COUNT(*) estado_led
    
    <b>Paneles interactivos:</b>
    âœ“ GrÃ¡fico lÃ­neas (histÃ³rico)
    âœ“ Indicador estado (actual)
    âœ“ Torta (distribuciÃ³n)
    âœ“ Tabla (Ãºltimas 20)
    âœ“ Stats (promedio/min/max)
    âœ“ Contador (eventos)
end note

note bottom of broker
    <b><color:#9C27B0>MQTT Pub/Sub</color></b>
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    <b>Ventajas vs HTTP:</b>
    âœ“ MÃ¡s ligero (â†“ ancho banda)
    âœ“ Mejor con conexiones inestables
    âœ“ Desacoplamiento dispositivos
    âœ“ Entrega instantÃ¡nea
    âœ“ Escalable (millones dispositivos)
    
    <b>Broker pÃºblico HiveMQ:</b>
    â€¢ Gratuito para prototipos
    â€¢ Sin autenticaciÃ³n
    â€¢ QoS 0 (fire and forget)
end note

' ========== LEYENDA CON MÃ‰TRICAS ==========

legend right
    <b><size:14>DATOS TÃ‰CNICOS DEL SISTEMA</size></b>
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    <b><color:#4CAF50>âš™ CONFIGURACIÃ“N:</color></b>
    â€¢ Umbral luminosidad: 750
    â€¢ Frecuencia lectura ESP32: 2 seg
    â€¢ Frecuencia actualizaciÃ³n Grafana: 5 seg
    â€¢ ADC Resolution: 12-bit (0-4095)
    â€¢ ADC Attenuation: 11dB (rango completo)
    
    <b><color:#2196F3>ğŸ”§ TECNOLOGÃAS:</color></b>
    â€¢ Hardware: ESP32 DevKit V1
    â€¢ Firmware: MicroPython 1.20+
    â€¢ Backend: Python 3.x
    â€¢ Protocolo: MQTT v3.1.1
    â€¢ Base de datos: MySQL 8.0+
    â€¢ VisualizaciÃ³n: Grafana 10.x
    
    <b><color:#FF9800>ğŸ“Š RENDIMIENTO:</color></b>
    â€¢ Latencia end-to-end: <1 segundo
    â€¢ Mensajes MQTT: 2 por ciclo
    â€¢ Registros BD: 1 por ciclo (2seg)
    â€¢ Consultas Grafana: N queries cada 5seg
    
    <b><color:#9C27B0>ğŸŒ ESCALABILIDAD:</color></b>
    â€¢ Dispositivos soportados: 100+
    â€¢ Costo por dispositivo: ~$15 USD
    â€¢ Almacenamiento: Ilimitado (MySQL)
    â€¢ Dashboards: MÃºltiples usuarios
end legend

@enduml
